namespace test;

entitydef test_entity {
    bool Invulnerable;
}

#test
void test_entity_exists() {
    start("entity exists");

    @/kill @e[type=wither]
    
    macro_entity_tester(false);
    assert(!@e[type="wither"]);

    summon("wither");

    macro_entity_tester(true);
    assert(@e[type="wither"]);

    @/kill @e[type=wither]

    macro_entity_tester(false);
    assert(!@e[type="wither"]);

    complete();
}

void macro_entity_tester(macro bool x) {
    string type = "wither";

    if (@e[type=type]) {
        assert(x);
    } else {
        assert(!x);
    }
}

#test
void test_entity_negate() {
    start("entity negate");

    @/kill @e[type=wither]
    @/summon wither ~ ~ ~ { CustomName: "womp1" }
    @/summon wither ~ ~ ~ { CustomName: "womp2" }

    assert(!@e[type="wither",name=!"womp1",name=!"womp2"]);

    summon("wither");

    assert(@e[type="wither",name=!"womp1",name=!"womp2"]);

    @/kill @e[type=wither]

    complete();
}

#test
void test_entity_tag() {
    start("entity tag");

    @/kill @e[type=wither]
    
    unsafe_string tag = "womp";

    summon("wither");
    @/tag @e[type=wither] add $(tag)
    
    assert(@e[tag=tag]);

    @/kill @e[type=wither]

    complete();
}

#test
void test_entity_ref() {
    start("entity ref");

    @/kill @e[type=wither]
    summon("wither");
    
    test_entity e = @e[type="wither", limit=1];
    
    assert(!e.Invulnerable);
    e.Invulnerable = true;
    assert(e.Invulnerable);

    @/kill @e[type=wither]

    complete();
}

#test
void test_entity_ref_ref() {
    start("entity ref ref");

    @/kill @e[type=wither]
    summon("wither");
    
    test_entity e = @e[type="wither", limit=1];
    test_entity^ ptr = e;

    assert(!ptr.Invulnerable);
    ptr.Invulnerable = true;
    assert(ptr.Invulnerable);

    @/kill @e[type=wither]

    complete();
}
